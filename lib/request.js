"use strict";var __importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ApiRequest=void 0;const querystring_1=__importDefault(require("querystring")),http_1=require("./http"),logger_1=require("./logger"),utils_1=require("./utils");class ApiRequest{constructor(t,e){var r,s,o,i,u;this.log=logger_1.Logger.create();const n=t.requestContext||{},{isBase64Encoded:d}=t,a=n.stage||"",h=n.resourcePath||n.routeKey;let p=t.path||t.rawPath||"/";a&&h&&0===p.indexOf(`/${a}/`)&&0!==h.indexOf(`/${a}/`)&&(p=p.substring(a.length+1)),p=utils_1.normalizePath(p);const g=e.awsRequestId||n.requestId,_="$default"===a?"":a,q=t.httpMethod||(null===(r=n.http)||void 0===r?void 0:r.method)||n.httpMethod||http_1.HttpMethod.GET,l=Object.assign({},t.queryStringParameters),c={};if(t.headers){for(const e in t.headers)c[e.toLowerCase()]=t.headers[e];c["x-request-id"]=g}const y=d?Buffer.from(t.body||"","base64").toString():t.body||"";let I;I=c["content-type"]&&c["content-type"].includes("application/x-www-form-urlencoded")?querystring_1.default.parse(y):"object"==typeof y?y:utils_1.parseBody(y);const f=n.connectionId||"",m=c.host||n.domainName,v=(c["x-forwarded-for"]||(null===(s=n.http)||void 0===s?void 0:s.sourceIp)||(null===(o=n.identity)||void 0===o?void 0:o.sourceIp)||"").split(",")[0].trim(),A=c["user-agent"]||(null===(i=n.http)||void 0===i?void 0:i.userAgent)||(null===(u=n.identity)||void 0===u?void 0:u.userAgent)||"";let x;x=n.elb?http_1.HttpIntegration.ALB:"2.0"===t.version?http_1.HttpIntegration.APIGW_HTTP_API:n.eventType?http_1.HttpIntegration.APIGW_WS_API:http_1.HttpIntegration.APIGW_REST_API,this._request={id:g,stage:_,method:q,route:h,path:p,query:l,headers:c,body:I,host:m,ip:v,userAgent:A,proxyIntegration:x,isBase64Encoded:d},f&&(this._request.connectionId=f)}get id(){return this._request.id}get stage(){return this._request.stage}get method(){return this._request.method}get path(){return this._request.path}get query(){return this._request.query}get params(){return this._request.params||{}}set params(t){this._request.params=t}get headers(){return this._request.headers}get body(){return this._request.body}get host(){return this._request.host}get ip(){return this._request.ip}get userAgent(){return this._request.userAgent}get proxyIntegration(){return this._request.proxyIntegration}get isBase64Encoded(){return this._request.isBase64Encoded}get connectionId(){return this._request.connectionId}get route(){return this._request.route}toRequest(){return this._request||{}}}exports.ApiRequest=ApiRequest;